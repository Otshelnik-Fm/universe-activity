## Описание:

Дополнение для WordPress плагина [WP-Recall](https://wordpress.org/plugins/wp-recall/) - добавляет возможность писать пользовательскую активность в базу данных, а так же выводить ее - формируя ленту активности сайта. 

p.s. - это базовое ядро. Оно пишет в базу, выводит из нее, но имеет ограничения (смотри ниже) 

------------------------------

## Demo:

На [этой странице](http://across-ocean.otshelnik-fm.ru/top-secret-addons/) и там же примеры  

В [личном кабинете](https://otshelnik-fm.ru/author/otshelnik-fm/) - под дополнением "User Info Tab"  
На [живом сайте](https://otshelnik-fm.ru/)  

Большой скрин: что видит [админ](http://across-ocean.otshelnik-fm.ru/wp-content/uploads/2017/07/snapshot.jpg)  

------------------------------

## Возможности:

- Пишет пользовательскую активность в свою таблицу в базе данных 
- Выводит пользовательскую активность 
- Система привилегий и доступов на выводимые события. Так, например, админ видит всю активность, гость (не залогиненный пользователь) видит установленный минимум информации. Вошедший на сайт - видит больше событий. А автор, в своем ЛК, видит свои события (например вход и выход с сайта) 
- Гибкий вывод событий с помощью шорткода 
- Счетчик событий 
- Кнопки фильтра событий 
- Возможность указать количество событий к выводу, включить или исключить события, выводить кнопки фильтра событий или нет, включить вывод событий юзера по его user_id 
- Имеется 5 предустановленных стилей (задаются атрибутом class в шорткоде) 
- Возможность влияния на привилегии к событиям (простой функцией переназначить событие - показать или скрыть его) 
- Интеграция с дополнением [User Info Tab](https://codeseller.ru/products/user-info-tab/) - но без постраничной навигации. Последние 30 событий пользователя. Ограничения снимаются дополнением [Universe Activity Extended](https://codeseller.ru/products/universe-activity-extended/)  
- В админке настройка позволяющая задать цвета от настройки цвета WP-Recall  
- Интеграция с Asgaros Forum (создал топик, удалил, поставил рейтинг за сообщение)  

------------------------------

## Ограничения. Чего нет в этой версии, но доступно в Extended версии: 

- В этом дополнении нет: постраничной навигации 
- В этом дополнении нет: ajax-а в пагинации 
- В этом дополнении нет: плавающего блока даты 
- В этом дополнении нет: плавного доведения до блока при навигации 
- В этом дополнении нет: возможности среди событий разместить свой информационный блок или рекламу  

Но все это есть в дополнении [Universe Activity Extended](https://codeseller.ru/products/universe-activity-extended/) - оно дополняет и расширяет возможности базового допа 

------------------------------

## Список дочерних дополнений к нему:

дополнения ниже расширяют возможности этого ядра.

- [Universe Activity Extended](https://codeseller.ru/products/universe-activity-extended/)  
- [Universe Activity Modal](https://codeseller.ru/products/universe-activity-modal/)
- [Universe Activity HeatMap](https://codeseller.ru/products/universe-activity-heatmap/)
- [Universe Activity Comments](https://codeseller.ru/products/universe-activity-comments/)
- ...  

------------------------------

## Список регистрируемых событий и логика:  

- [x] пишет когда пользователь залогинился через ВП  
- [x] когда юзер залогинился через плагин uLogin и какая сеть  
- [x] когда зарегистрировался  
        &nbsp;&nbsp;&nbsp;&nbsp; если в WP-Recall стоит подтверждение регистрации - то запишет как ее подтвердит  
- [x] неверная регистрация и причина  
- [x] выход с сайта  
- [x] при удалении юзера - запишем кто удалил его и очистим историю удаленного юзера  
- [x] обновил настройки профиля  
- [x] поставил рейтинг за: *Проголосовал -10 за запись: для фида 2 без море*  
        &nbsp;&nbsp;&nbsp;&nbsp; если это товар: *Проголосовал +10 за товар: Кот в мешке*  
        &nbsp;&nbsp;&nbsp;&nbsp; если это группа: *Проголосовал +5 за запись: "Посёлок программистов", в группе Открытая 2019*  
- [x] оставил комментарий: *Оставил комментарий к записи: "для фида 2 без море"*  
        &nbsp;&nbsp;&nbsp;&nbsp; если это комментарий к записе в группе - то выводит и название группы: *Оставил комментарий к записи: "Я вижу как закат стёкла оконные плавит…" в группе "Скрытые возможности Теней!"*  
        &nbsp;&nbsp;&nbsp;&nbsp; ссылка будет короткой и ведет к самому комментарию, а имя группы - ссылка на группу  
        &nbsp;&nbsp;&nbsp;&nbsp; если это комментарий к товару то и пишем: *Оставил комментарий к товару: "Продам робота"*  
        &nbsp;&nbsp;&nbsp;&nbsp; статус комментария, если он отличается от опубликованного, учитывается. И ссылка на коммент не выводится  
- [x] при удалении комментария - удаляется он из таблицы  
- [x] опубликовал запись:  
        &nbsp;&nbsp;&nbsp;&nbsp; если модерации нет  
        &nbsp;&nbsp;&nbsp;&nbsp; если модерация есть - пишется время и статус (add_post), но ссылка на запись не видна. Видна лишь тем кто имеет право редактировать запись (сам автор, редакторы и админ)  
        &nbsp;&nbsp;&nbsp;&nbsp; если админ одобрил ее - время публикации не меняется, появляется ссылка на нее  
- [x] убрал ее в черновики  
- [x] удалил запись  
- [x] полное удаление записи с сайта (очистил корзину или если корзина отключена, т.е. когда запись удаляется безвозвратно)  
        &nbsp;&nbsp;&nbsp;&nbsp; если полное удаление записи - чистим всю историю по нему, кроме факта (строки) полного удаления  
- [x] ловим когда при сохранении настроек профиля меняют статус (description). Фиксируем это. При повторной смене статуса - время смены статуса переписывается  
- [x] подписался на пользователя, отписался от него  
        &nbsp;&nbsp;&nbsp;&nbsp; если юзер начинает тыкать "подписаться/отписаться" - я стираю при подписке эти два поля и фиксирую новое событие. Избавляемся от дублей  
- [x] добавление и удаление юзеров в черный список  
        &nbsp;&nbsp;&nbsp;&nbsp; логика работы как у подписок - исключая тыканье "добавить/убрать" из блеклиста  
- [x] создал тему на Prime-Forum  
        &nbsp;&nbsp;&nbsp;&nbsp; ссылка на топик формируется короткая - меньше запросов к бд  
- [x] удалил тему с форума Prime-Forum. Если тему удаляет не сам автор - то пишу чья тема была удалена  
- [x] рейтинг за комментарий на PrimeForum  
        &nbsp;&nbsp;&nbsp;&nbsp; ссылка на комментарий форума формируется короткая - меньше запросов к бд  
- [x] ловим событие загрузки обложки в ЛК. При загрузки другой обложки дата события меняется  
        &nbsp;&nbsp;&nbsp;&nbsp; это событие будет доступно в фильтре "Обновления"  
- [x] ловим событие загрузки аватарки в ЛК  
        &nbsp;&nbsp;&nbsp;&nbsp; это событие будет доступно в фильтре "Обновления"  
- [x] ловим событие удаления аватарки  
        &nbsp;&nbsp;&nbsp;&nbsp; событие видит автор и админ  
        &nbsp;&nbsp;&nbsp;&nbsp; в этом случае удаляем событие загрузки аватарки - т.к. картинки нет, выводить нечего  
        &nbsp;&nbsp;&nbsp;&nbsp; и если есть еще одно событие удаления аватарки - удалим его  
- [x] создал тему на Asgaros Forum  
        &nbsp;&nbsp;&nbsp;&nbsp; ссылка на топик формируется короткая - меньше запросов к бд  
- [x] удалил тему с Asgaros Forum. Если тему удаляет не сам автор - то пишу чья тема была удалена  
- [x] рейтинг за комментарий на Asgaros Forum (дополнение Asgaros Forum + WP-Recall)  
        &nbsp;&nbsp;&nbsp;&nbsp; ссылка на комментарий форума формируется короткая - меньше запросов к бд  
- [x] указал свой город, сменил город, удалил город (дополнение Country & User in Profile PRO)  
        &nbsp;&nbsp;&nbsp;&nbsp; Первые 2 видят залогиненные. Второе - только админ  
        &nbsp;&nbsp;&nbsp;&nbsp; установил город - указывается город  
        &nbsp;&nbsp;&nbsp;&nbsp; сменил город - указывается старый и новый город  
        &nbsp;&nbsp;&nbsp;&nbsp; удалил город - указывается старый город  
        &nbsp;&nbsp;&nbsp;&nbsp; эти события будут доступны и в кнопке-фильтре "Обновления"  
- [x] установил день рождения, сменил дату рождения (дополнение Birthday in Profile)  
        &nbsp;&nbsp;&nbsp;&nbsp; установил день рождения (событие видит админ)  
        &nbsp;&nbsp;&nbsp;&nbsp; сменил дату рождения (событие видит админ)  
        &nbsp;&nbsp;&nbsp;&nbsp; эти события выводятся также в кнопке-фильтре "Обновления"  
- [x] запросил статистику по себе в чате (доп Bot User Info)  
        &nbsp;&nbsp;&nbsp;&nbsp; пишет событие, когда пользователь запросил информацию по себе (событие видит админ)  
- [x] оформил подписку на комментарии записей и форума или удалил подписку (доп Subscription Two)  
        &nbsp;&nbsp;&nbsp;&nbsp; оформил подписку на комментарии записей или форума (событие видит залогиненный)  
        &nbsp;&nbsp;&nbsp;&nbsp; удалил подписку на комментарии записей или форума (событие видит админ)  
- [x] сменил урл кабинета (событие видит админ)(доп Pretty URL Author)  
- [x] поддержка событий дополнений Групп (Group Recall):  
        &nbsp;&nbsp;&nbsp;&nbsp; ловим создание новой группы  
        &nbsp;&nbsp;&nbsp;&nbsp; удаление группы (админка)  
        &nbsp;&nbsp;&nbsp;&nbsp; при удалении группы на строчку созданной группы вешаем маркер del - и наша система не будет на нее давать ссылку  
        &nbsp;&nbsp;&nbsp;&nbsp; вступил в группу/покинул ее/удалили из группы (если админ в списке пользователей группы удалил его из группы)  
        &nbsp;&nbsp;&nbsp;&nbsp; установил (сменил) описание группы (событие видят все)  
        &nbsp;&nbsp;&nbsp;&nbsp; смена статуса группы: открытая/закрытая  
        &nbsp;&nbsp;&nbsp;&nbsp; пользователь забанен в группе  
        &nbsp;&nbsp;&nbsp;&nbsp; у пользователя сменили роль в группе  
- [x] установил или сменил статус группы (событие видят все)(доп Groups Theme RePlace)  
- [x] установил или сменил аватарку группы (событие видят все)(доп Groups Theme RePlace)  
- [x] установил или сменил обложку группы (событие видят все)(доп Groups Theme RePlace)  

------------------------------

## Список событий по группам:  

Активность дополнение пишет: как самого WordPress, WP-Recall плагина, сторонних плагинов и дополнений к WP-Recall.  
Важно понимать: что пока дополнения или плагины отключены - регистрация связанных с ними событий не производится.  
Ниже я собрал список регистрируемых событий по таким категориям.  


### WordPress:  

| slug | действие | привилегия |
|------|----------|------------|
| register | зарегистрировался | залогиненный |  
| register_failed | неудачная регистрация | админ |  
| delete_user | удалил юзера | админ |  
| logged_in | пользователь вошел на сайт | автор |  
| logged_out | пользователь вышел с сайта | автор |  
| add_post | добавлена запись | гость |  
| add_draft | добавил черновик | залогиненный |  
| delete_post | удалил запись - в корзину | админ |  
| delete_post_fully | удалил запись навсегда. Или автоочистка корзины по крону | админ |  
| add_comment | добавлен комментарий | гость |  
| profile_update | обновил настройки профиля | админ |  
| change_status | юзер сменил свой статус | гость |  



### Плагины:  

#### WP-Recall  

| slug | действие | привилегия |
|------|----------|------------|
| add_cover | юзер добавил обложку в своём ЛК | гость |  
| add_avatar | юзер добавил/сменил аватарку (локальная аватарка. не граватар) | гость |  
| del_avatar | юзер удалил свой аватар (локальный, не граватар) | автор |  
| confirm_register | подтвердил регистрацию | залогиненный |  
| add_user_blacklist | добавил в черный список | залогиненный |  
| del_user_blacklist | удалил из черного списка | залогиненный |  


дополнения из базовой части плагина:  

**Rating System**  

| slug | действие | привилегия |
|------|----------|------------|
| give_rating_comment | рейтинг за комментарий | гость |  
| give_rating_notes | рейтинг за заметку (+доп: Notes) | гость |  
| give_rating_post | рейтинг за запись - тип post | гость |  
| give_rating_forum-post | рейтинг за сообщение на Prime Forum (+доп: Prime Forum) | гость |  
| give_rating_forum-page | рейтинг за сообщение на Asgaros Forum (+доп: Asgaros Forum + WP-Recall) | гость |  
| give_rating_post-group | рейтинг за запись в группе - тип post-group (+доп: Groups) | гость |  
| give_rating_products | рейтинг за товар - тип products (+доп: Commerce) | гость |  


**Feed**  

| slug | действие | привилегия |
|------|----------|------------|
| add_user_feed | подписался на юзера | гость |  
| del_user_feed | отписался от юзера | залогиненный |  


**Groups**  

| slug | действие | привилегия |
|------|----------|------------|
| create_group | создал группу | гость |  
| delete_group | удалил группу | админ |  
| user_in_group | юзер вступил в группу | гость |  
| group_change_desc | установил или сменил описание группы | гость |  
| user_out_group | вышел из группы/удалили из группы | залогиненный |  
| group_user_ban | пользователя забанили в группе | залогиненный |  
| group_user_role | пользователю назначили роль в группе | залогиненный |  
| group_is_closed | смена статуса группы: открытая/закрытая | залогиненный |  


**PrimeForum**  

| slug | действие | привилегия |
|------|----------|------------|
| pfm_add_topic | создана новая тема на Prime Forum | гость |  
| pfm_del_topic | удалил тему с форума (Prime Forum) | админ |  



#### uLogin:  

| slug | действие | привилегия |
|------|----------|------------|
| logged_in_ulogin | вошел на сайт и через какую сеть | автор |  


#### Asgaros Forum:  

| slug | действие | привилегия |
|------|----------|------------|
| asgrs_add_topic | создана новая тема на Asgaros Forum | гость |  
| asgrs_del_topic | удалил тему с форума (Asgaros Forum) | админ |  


### Дополнения WP-Recall:  

**Birthday in Profile**  

| slug | действие | привилегия |
|------|----------|------------|
| bip_add_dob | установил день рождения | админ |  
| bip_change_dob | сменил дату рождения | админ |  


**Bot User Info**  

| slug | действие | привилегия |
|------|----------|------------|
| bui_get_info | запросил статистику в чате | админ |  


**Country & User in Profile PRO**  

| slug | действие | привилегия |
|------|----------|------------|
| cpp_add_city | добавил город | залогиненный |  
| cpp_change_city | сменил город | залогиненный |  
| cpp_del_city | удалил город | админ |  


**Groups Theme RePlace**  

| slug | действие | привилегия |
|------|----------|------------|
| group_change_exc | установил или сменил статус группы | гость |  
| add_group_avatar | установил или сменил аватарку группы | гость |  
| add_group_cover | установил или сменил обложку группы | гость |  


**Pretty URL Author**  

| slug | действие | привилегия |
|------|----------|------------|
| pua_change_url | сменил урл кабинета | админ |  


**Subscription Two**  

| slug | действие | привилегия |
|------|----------|------------|
| sbt_add_subs | оформил подписку на комментарии записей или форума | залогиненный |  
| sbt_del_subs | удалил подписку на комментарии записей или форума | админ |  


------------------------------

## События и привилегии:  

Дополнение позволяет разным типам пользователей видеть разные события. Так что все события видит только админ, а гость видит минимум - у него есть мотивация зарегистрироваться или войти на сайт чтобы видет больше событий.  
Ниже таблица все объясняет.  

### Привилегии:  

- Гость - пользователь не вошедший на сайт. Если у события нет привилегии доступа - значит видно всем, начиная с гостя.  
- Залогинен - 'logged'  
- Автор (в своем ЛК - это если передан атрибут шорткода include_users="author_lk") - 'logged' и 'author'  
- Админ - 'logged', 'author', 'admin'  

### События:  

#### Гость видит:  
 
| slug | действие |
|------|----------|
| add_comment | добавлен комментарий |  
| add_post | добавлена запись |  
| change_status | юзер сменил свой статус |  
| give_rating_comment | рейтинг за комментарий |  
| give_rating_notes | рейтинг за заметку |  
| give_rating_post | рейтинг за запись - тип post |  
| give_rating_forum-post | рейтинг за сообщение на Prime Forum |  
| give_rating_forum-page | рейтинг за сообщение на Asgaros Forum (дополнение Asgaros Forum + WP-Recall) |  
| give_rating_post-group | рейтинг за запись в группе - тип post-group |  
| give_rating_products | рейтинг за товар - тип products |  
| add_user_feed | подписался на юзера |  
| create_group | создал группу |  
| user_in_group | юзер вступил в группу |  
| pfm_add_topic | создана новая тема на Prime Forum |  
| add_cover | юзер добавил обложку в своём ЛК |  
| add_avatar | юзер добавил (сменил) аватарку (локальная аватарка. не граватар) |  
| asgrs_add_topic | создана новая тема на Asgaros Forum |  
| group_change_desc | установил или сменил описание группы |  
| group_change_exc | установил или сменил статус группы (дополнение Groups Theme RePlace) |  
| add_group_avatar | установил или сменил аватарку группы (дополнение Groups Theme RePlace) |  
| add_group_cover | установил или сменил обложку группы (дополнение Groups Theme RePlace) |  


#### Залогиненый видит: те что выше, плюс:  

| slug | действие |
|------|----------|
| add_draft | добавил черновик |  
| confirm_register | подтвердил регистрацию |  
| register | зарегистрировался |  
| del_user_feed | отписался от юзера |  
| add_user_blacklist | добавил в черный список |  
| del_user_blacklist | удалил из черного списка |  
| user_out_group | вышел из группы/удалили из группы |  
| group_user_ban | пользователя забанили в группе |  
| group_user_role | пользователю назначили роль в группе |  
| group_is_closed | смена статуса группы: открытая/закрытая |  
| cpp_add_city | добавил город (Country & User in Profile PRO) |  
| cpp_change_city | сменил город (Country & User in Profile PRO) |  
| sbt_add_subs | оформил подписку на комментарии записей или форума (Subscription Two) |  


#### Автор видит: все что выше, плюс:  

| slug | действие |
|------|----------| 
| logged_in | когда он вошел на сайт |  
| logged_in_ulogin | когда он вошел через плагин u-login и через какую сеть |  
| logged_out | когда он вышел с сайта |  
| del_avatar | когда он удалил свой аватар (локальный, не граватар) |  

#### Админ видит: все что выше, плюс:  

| slug | действие |
|------|----------| 
| delete_post | удалил запись - в корзину |  
| delete_post_fully | удалил запись навсегда. Если это автоочистка корзины - пишет "wp-cron" |  
| delete_user | удалил юзера |  
| profile_update | обновил настройки профиля |  
| register_failed | неудачная регистрация |  
| delete_group | удалил группу |  
| pfm_del_topic | удалил тему с форума (Prime Forum) |  
| asgrs_del_topic | удалил тему с форума (Asgaros Forum) |  
| cpp_del_city | удалил город (Country & User in Profile PRO) |  
| bip_add_dob | установил день рождения (Birthday in Profile) |  
| bip_change_dob | сменил дату рождения (Birthday in Profile) |  
| bui_get_info | запросил статистику в чате (Bot User Info) |  
| sbt_del_subs | удалил подписку на комментарии записей или форума (Subscription Two) |  
| pua_change_url | сменил урл кабинета (Pretty URL Author) |  

------------------------------

## Шорткод:  

Дополнение автоматически ничего нигде не выводит. За исключением поддержки дополнения [User Info Tab](https://codeseller.ru/products/user-info-tab/) - но без постраничной навигации (там выводит последние 30 событий пользователя)  
(чтобы у User Info Tab была постраничная навигация нужно поставить дополнение [Universe Activity Extended](https://codeseller.ru/products/universe-activity-extended/) )  

Итак - всё выводим с помощью шорткода: `[otfm_universe filter=1]`  

**Дополнительные атрибуты шорткода:**   

**filter** - показывать кнопки фильтра. Поставьте "1" чтобы выводить сверху фильтр по событиям (по умолчанию 0). Над активностью выведется 6-ть кнопок: Все, Публикации, Комментарии, Рейтинг, Обновления, Подписки    

**number** - количество событий на странице (по умолчанию 30). Поставьте "-1" чтобы вывести все. Для постраничной навигации вам нужно дополнение [Universe Activity Extended](https://codeseller.ru/products/universe-activity-extended/)   

**include_actions** - включить эти события. Через запятую (события -slug- на английском смотрите выше в "Событиях и привилегиях" или "Список событий по группам"). Ничего не вписывайте если хотите вывести их все.  

**exclude_actions** - исключить события (нельзя в атрибутах одновременно использовать include_actions и exclude_actions. Что-то одно)  

**include_users** - включая юзеров. Через запятую (id юзеров - число).  
В личном кабинете в произвольной вкладке WP-Recall допустимо вписать `author_lk` и система подставит туда id автора кабинета.  
За пределами ЛК используйте `current` - система подставит туда id текущего залогиненного юзера.  

**events_count** - верхний счетчик, показывающий кол-во событий (по умолчанию значение "1" - показывать). `events_count="0"` - отключит его  

**class** - wrapper (обёртка) css class главного блока [скриншот](https://yadi.sk/i/f1OvpO_E3LmcZh). Например чтобы вы создали свой дизайн вывода. На основе этого атрибута уже подготовлено несколько значений:  
(если не указан - то дизайн будет самый минималистичный)  
"una_zebra" - простой зеброй  
"una_basic" - базовый  
"una_modern" - модерн стиль  

**Примеры:**  

1. Выведем модерновый стиль, фильтр и 40 записей:  
`[otfm_universe class="una_modern" number="40" filter=1]`  

2. Выведем, создав в админке вашего сайта: "WP-Recall" -> "Менеджер вкладок" - вкладку в ЛК, чтобы она показывала только события автора кабинета:  
`[otfm_universe filter=1 include_users="author_lk"]`  

3. Выведем все события: комментарии и рейтинг за них. Без фильтра сверху:  
`[otfm_universe class="una_basic" number="-1" include_actions="add_comment,give_rating_comment"]`  

4. Выведем все рейтинги и стилизуем базовым стилем:  
`[otfm_universe class="una_basic" include_actions="give_rating_comment,give_rating_notes,give_rating_post,give_rating_post-group,give_rating_products,give_rating_forum-post,give_rating_forum-page"]`  

5. Выведем активность входа текущего пользователя:  
`[otfm_universe include_actions="logged_in" include_users="current"]`  


------------------------------

## Какие события включены в фильтр:  

**Публикации** - add_post  
**Комментарии** - add_comment  
**Рейтинг** - give_rating_comment,give_rating_notes,give_rating_post,give_rating_forum-page,give_rating_post-group,give_rating_products,give_rating_forum-post    
**Обновления** - change_status,profile_update,create_group,user_in_group,pfm_add_topic,asgrs_add_topic,add_cover,add_avatar   
**Подписки** - add_user_feed  

------------------------------

## FAQ:  

#### Установил дополнение - не вижу ничего  
- Нужно вывести шорткодом. Смотри описание шорткода и конечно же должно быть записано хоть одно событие в базу - админ видит их все.  
  
  
#### Я вижу не все события из последних. Некоторые скрыты  
- У дополнения есть система событий и привилегий. Читай выше **"События и привилегии"**  
  
  
#### Установил, вывел. Пишет счетчик: событий 100, но я вижу только 30  
- По умолчанию и выводит 30. Нужно вывести все - ставь в атрибут шорткода `number="-1"`. Нужна постраничная навигация ставь дополнение [Universe Activity Extended](https://codeseller.ru/products/universe-activity-extended/) (читай пункт **"Ограничения"**)  
  
  
#### Как вывести активность пользователя в его личном кабинете?  
- Читай пункт **"Шорткод"**. Второй пример.  
  
  
#### Вывел фильтр - но я не вижу рейтинг и подписки  
- Дополнения "Rating System (Система рейтинга)" и "Feed (Подписки)" должны быть у вас активны  
  
  
#### У дополнения есть настройки?  
- Да. В админке: "WP-Recall" -> "Настройки Universe Activity"  
  
  
#### А в какой таблице в базе данных хранятся события?  
- Смотрите таблицу: **wp_otfm_universe_activity**  
  
  
#### Как в лайтбоксе увеличивать аватарки и обложки? -открывает картинку в отдельной вкладке  
- Ставьте дополнение для просмотра увеличенных изображений [Magnific Popup Recall](https://codeseller.ru/products/magnific-popup-recall/)  
  
  
#### Удалив это дополнение я потеряю данные о активности?  
- При удалении дополнения через менеджер дополнений - оно за собой удалит свою таблицу, в которой он хранит пользовательскую активность.  
  
  
#### Вписал шорткод в менеджере вкладок. Поставил галку на "кеширование" и все разъехалось (стили не загружаются)  
- При кешировании вкладки (когда html из кеша отдается) дело до функции шорткода не доходит. Поэтому стили не загружаются (а стили у нас грузятся только там где требуется)  
Значит вам нужно вручную вызвать нужные стилевые файлы для нужной вкладки.  
  
Решение проблемы:  
1-вариант: Отключить поддержку кеширования у вкладки. Это самый простой и надежный способ. Больше ничего делать не нужно.  
  
2-вариант:  
Вам нужно открыть в админке в "Менеджере вкладок" вкладку с шорткодом и посмотреть "Идентификатор вкладки". В моем случае он `aktivnost_89`  
Вписать в ваш functions.php следующий сниппет (отредактируйте под свой случай):  
```
// Universe Activity. ручной старт когда вкладка закеширована  
function otfm_una_manual_load_styles(){  
    if(!rcl_exist_addon('universe-activity')) return false; // наш доп не активирован  
  
    una_manual_start($class = 'author_lk'); // передаем сюда из шорткода атрибут class. Или, если вызываете шорткод для конкретного юзера, впишите author_lk  
}  
add_action('rcl_construct_aktivnost_89_tab', 'otfm_una_manual_load_styles'); // вместо aktivnost_89 - вписываем свой id вкладки на котором вызываете шорткод  

```
  
- обратите внимание на формирование динамического хука rcl_construct_<strong>aktivnost_89</strong>_tab вместо <strong>aktivnost_89</strong> вписывайте свой идентификатор вкладки  
- в функцию на 5 строке передавайте значение из атрибута class шорткода. А если вы просто выводите активность конкретного юзера - то впишите author_lk  
таким образом загрузится основной стилевой файл и стили для конкретного вызова (author_lk - значит файл будет загружаться una_one_user.css)  

------------------------------

## Установка/Обновление  

**Установка:**  
Т.к. это дополнение для WordPress плагина WP-Recall, то оно устанавливается через [менеджер дополнений WP-Recall](https://codeseller.ru/obshhie-svedeniya-o-dopolneniyax-wp-recall/)  

1. В админке вашего сайта перейдите на страницу "WP-Recall" -> "Дополнения" и в самом верху нажмите на кнопку "Обзор", выберите .zip архив дополнения на вашем пк и нажмите кнопку "Установить".  
2. В списке загруженных дополнений, на этой странице, найдите это дополнение, наведите на него курсор мыши и нажмите кнопку "Активировать". Или выберите чекбокс и в выпадающем списке действия выберите "Активировать". Нажмите применить.  


**Обновление:**  
Дополнение поддерживает [автоматическое обновление](https://codeseller.ru/avtomaticheskie-obnovleniya-dopolnenij-plagina-wp-recall/) - два раза в день отправляются вашим сервером запросы на обновление.  
Если в течении суток вы не видите обновления (а на странице дополнения вы видите что версия вышла новая), советую ознакомиться с этой [статьёй](https://codeseller.ru/post-group/rabota-wordpress-krona-cron-prinuditelnoe-vypolnenie-kron-zadach-dlya-wp-recall/) 

------------------------------

## Changelog  

**2019-03-15**  
v0.30   

- [x] поддержка WP-Recall 16.16  
- [x] для крон события добавлена своя аватарка  
- [x] тип записи "wp_block" не участвует в логах. Это создание, импорт или удаление гутенберг блока  
- [x] теперь при выставлении рейтинга к посту в группе пишется и имя группы. Пример: "Проголосовал +5 за запись: "Посёлок программистов", в группе Открытая 2019"  
- [x] в прошлых версиях был добавлен в отдельный пункт (item) css класс определяющий что за тип данных выводится - [скриншот](https://yadi.sk/i/oWgYPnmR3KJutL) - так вы можете кастомизировать отдельное событие и обыграть стилями  

- [x] Добавлены фильтры:  
`una_filter_updates` передает один аргумент - массив событий для вывода в кнопке-фильтре "Обновления"  
(пример, как работать - смотри в файле integration/addon-country-and-city-in-profile-pro.php 4-й пункт)  
`una_filter_publications` передает один аргумент - массив событий для вывода в кнопке-фильтре "Публикации"  
`una_filter_comments` передает один аргумент - массив событий для вывода в кнопке-фильтре "Комментарии"  
`una_filter_ratings` передает один аргумент - массив событий для вывода в кнопке-фильтре "Рейтинг"  
`una_filter_subscriptions` передает один аргумент - массив событий для вывода в кнопке-фильтре "Подписки"  

- [x] db_version = '1.1.0':  
добавлена колонка group_id (число) - содержит id группы. Для полноценной поддержки дополнения групп  
добавлена колонка hide (число) - маркер "1" укажет что событие в архиве (скрыто)  

- [x] Добавлена константа `UNA_DB` - для быстрого доступа к таблице БД `wp_otfm_universe_activity`  


- [x] Добавлена поддержка событий дополнения Country & User in Profile PRO:  
установил город, сменил город, удалил город. Первые 2 видят залогиненные. Второе - только админ.  
установил город - указывается город  
сменил город - указывается старый и новый город  
удалил город - указывается старый город  
\- эти события выводятся также в кнопке-фильтре "Обновления"  


- [x] Добавлена поддержка событий дополнения Birthday in Profile:  
установил день рождения (событие видит админ)  
сменил дату рождения (событие видит админ)  
\- эти события выводятся также в кнопке-фильтре "Обновления"  


- [x] Добавлена поддержка дополнения Bot User Info:  
пишет событие когда пользователь запросил информацию по себе (событие видит админ)  


- [x] Добавлена поддержка дополнения Subscription Two:  
оформил подписку на комментарии записей или форума (событие видит залогиненный)  
удалил подписку на комментарии записей или форума (событие видит админ)  


- [x] Добавлена поддержка дополнения Pretty URL Author:  
сменил урл кабинета (событие видит админ)  


- [x] Добавлена поддержка событий дополнений Групп (Group Recall):  
установил (сменил) описание группы (событие видят все)  
смена статуса группы: открытая/закрытая  
пользователь забанен в группе  
у пользователя сменили роль в группе  
теперь ловится не только выход из группы, но также если админ в списке пользователей группы удалил его из группы  


- [x] Добавлена поддержка событий дополнения Groups Theme RePlace:  
установил (сменил) статус группы (событие видят все)  
установил или сменил аватарку группы (событие видят все)  
установил или сменил обложку группы (событие видят все)  



**2018-04-22**  
v0.23  

- [x] добавлены дополнительные классы оборачивающие главный контейнер:  
Если ничего нету - добавляется класс `una_wrapper_all`  
И если переходим по фильтру то соответственно: `una_wrapper_publications`, `una_wrapper_comments`, `una_wrapper_ratings`, `una_wrapper_updates`, `una_wrapper_subscriptions`  



**2018-01-17**  
v0.22  

- [x] Реорганизация файловой структуры. Была проблема - отключив плагин (пример: asgaros forum) события его работы продолжали выводиться  
это неверно - т.к. к отключенному плагину могли идти запросы (к его функциям).  
Теперь в папке `integration` будут создаваться файлы каждый на свой доп или плагин.  



**2017-12-16**  
v0.21  

- [x] Тип записи `custom_css` не учитывается в активности (это кастомные стили что ввели в новой версии ВП)  



**2017-11-23**  
v0.20.1  

- [x] Подправил еще стили для админки  



**2017-11-23**  
v0.20  

- [x] Подправил стили для админки  
- [x] Немного рекламы своих допов к Universe Activity в блоке настроек допа  



**2017-11-22**  
v0.19  

- [x] Убрал фиксацию бесполезного ВП типа записей `oembed_cache`. Она создавалась если контент записи содержал oEmbed  



**2017-11-18**  
v0.18  

- [x] Оптимизировал доп по запросам к БД  



**2017-11-09**  
v0.17  

- [x] Возможность в атрибуте шорткода `class` передавать несколько классов  



**2017-11-03**  
v0.16  

- [x] Добавил служебную информацию - версию бд системы. Необходимо будет чтобы делать её апгрейд  
- [x] Добавлен новый параметр в шорткод `events_count` - указав его значение 0 - отключим счетчик событий. По умолчанию "1" - включен.  
- [x] Добавлен фильтр `una_get_data_db` - фильтр массива полученных на страницу данных. Можно применять для дополнения массива своими данными  
- [x] Очистка передаваемых `include`, `exclude` аргументов шорткода от возможных пробелов.  
- [x] Статус комментариев выделил цветом. "На утверждении" - оранжевый, "Спам" - красный  
- [x] Поддержка дополнения [Universe Activity Comments](https://codeseller.ru/products/universe-activity-comments/)  



**2017-10-28**  
v0.15  

- [x] Поддержка дополнения [Universe Activity Modal](https://codeseller.ru/products/universe-activity-modal/)  



**2017-10-09**  
v0.14  

- [x] Исправлен баг приводящей к игнорированию любых из капч при регистрации ( спасибо за репорт Игорю (garry) )  


**2017-09-25**  
v0.13  

- [x] Исправил ошибку проверки на дубликаты. Спасибо Игорь (garry)  


**2017-08-23**  
v0.12  

- [x] Уточнил проверку - в админке мы или нет. Не влияет теперь на ajax запрос  
- [x] Ввел новую переменную запроса - короткую ссылку на кабинет автора (спасибо пользователю Kerncraft1 за репорт). Т.к. ВП функция редиректа короткой ссылки автора работает через раз  



**2017-08-22**  
v0.11  

- [x] Добавлена иконка дополнения  
- [x] Поддержка плагина Asgaros Forum (не ниже версии 1.5.9)  
    Ловим событие создания новой темы на форуме  
    Ловим события удаления темы форума  
- [x] Рейтинг за сообщение на Asgaros Forum (дополнение [Asgaros Forum + WP-Recall](https://codeseller.ru/products/asgaros-forum-wp-recall/))  
    ссылка на комментарий форума формируется короткая - меньше запросов к бд  
- [x] Добавлен вывод 30-ти последних событий в админке на странице консоли WP-Recall  



**2017-08-16**  
v0.10  

- [x] Исправлен баг: при попытке вывести одно лишь событие удаления пользователя (`include_actions="delete_user"`) - для админа все работает, а с правами для других пользователей происходил игнор.  
- [x] Добавлен новый параметр в атрибут шорткода: `include_users` принимает параметр `current` (получит id текущего авторизованного юзера)  
Пример: `[otfm_universe include_actions="logged_in" include_users="current"]` - выведет нам все входы текущего пользователя. Если не указать `include_users="current"` - то шорткод выдаст нам все входы всех пользователей  
Для ЛК был подобный параметр `author_lk`  



**2017-08-15**  
v0.9  

- [x] работа с плагином WP-Recall верси 16.5.0! и выше  
- [x] добавил поддержку рейтинга дополнения [Prime Forum](https://codeseller.ru/products/primeforum/)  
    короткая ссылка на запись (топик)  
- [x] дополнил стили одиночной страницы иконками  
- [x] событие, фиксирующее удаление пользователя (видимое только админу) теперь еще содержит и email удаленного юзера  
- [x] ловим событие загрузки обложки в ЛК. При загрузки другой обложки дата события меняется  
    это событие будет доступно в фильтре "Обновления"  
- [x] ловим событие загрузки аватарки в ЛК  
    это событие будет доступно в фильтре "Обновления"  
- [x] ловим событие удаления аватарки  
    событие видит автор и админ  
    в этом случае удаляем событие загрузки аватарки - т.к. картинки нет, выводить нечего  
    и если есть еще одно событие удаления аватарки - удалим его  
- [x] обложки и аватарки можно просматривать в лайтбоксе. Я работаю с дополнением [Magnific Popup Recall](https://codeseller.ru/products/magnific-popup-recall/)  



**2017-08-10**  
v0.8.1  

- [x] Устранил существующую ошибку  



**2017-08-10**  
v0.8  

- [x] работа над тесной интеграцией с [Universe Activity Extended](https://codeseller.ru/products/universe-activity-extended/)  
- [x] изменение страницы настроек дополнения  
- [x] решение проблемы: когда в менеджере вкладок выставлено кеширование вкладки. Читай в FAQ  



**2017-08-09**  
v0.7  

- [x] добавил хук (action) `una_start_shortcode` - срабатывает на странице с шорткодом. 
- [x] в админке появились настройки. Пока одна "Используем цвета из "основного цвета" WP-Recall?" - выбрав "Да" - цветовая гамма блоков будет формироваться на основе цвета WP-Recall  



**2017-08-07**  
v0.6.1  

- [x] вырубил функцию своего дебага. У вас ее нет и не нужна  

  
 
**2017-08-07**   
v0.6  

- [x] ООП  
- [x] Исправление уведомлений уровня notice  
- [x] Исправлены найденные баги  
- [x] Пагинация, плавающий блок даты, плавное доведение до верха блока - это отделилось в стороннее решение [Universe Activity Extended](https://codeseller.ru/products/universe-activity-extended/)  
ядро дополнения (сам доп "Universe Activity") распространяется бесплатно.  
Мотив простой - базовая версия самодостаточна и ее можно использовать как фреймворк. А бесплатное распространение позволит охватить максимум аудитории и сделать базу еще крепче и гибче.  
Отдельными дополнениями будет наращиваться к ней функционал - кому-то нужный (возьмет), а кому дополнительно обвязка не нужна - не будет нагружать сервак.  



**2017-08-03**  
v0.5  

- [x] вывел фильтры: Все, Публикации, Комментарии, Рейтинг, Обновления, Подписки  
- [x] переработал стили  
- [x] добавил новые атрибуты в шорткод  



**2017-07-11**  
v0.4  

- [x] ajax пагинация на странице вывода шорткодом.  
- [x] плавное доведение блока вверх.  



**2017-07-07**  
v0.3  

- [x] Постраничная навигация (пагинация) - возможно установить свое кол-во для вывода, или если -1 - выведет все.  



**2017-07-06**  
v0.2  

- [x] Использование класса [Rcl_Query](https://codeseller.ru/post-group/rcl_query-udobnyj-klass-dlya-postroeniya-zaprosov-k-bd-ot-wp-recall/) от WP-Recall  
- [x] На данный момент дополнение позволяет выводить шорткодом данные:  
1. Указать id пользователей которых выводить, или наоборот - которых исключить.  
2. Позволяет указать конкретные действия которые выводить, или наоборот - какие исключить. Поддерживая при этом приватность в зависимости от привилегий пользователя.  
3. Позволяет установить сколько элементов на страницу выводить (для постраничной навигации, ее пока нет еще)  
4. Позволяет установить в шорткоде класс которым будет оборачиваться главный блок - это вам позволит каждый шорткод, к примеру, стилизовать по своему.  
Я подготовил другой внешний вид - как пример возможностей.  



**2017-05-28**  
v0.007  

- [x] Идея, проектирование бд и первый код.  

------------------------------

## Поддержка и контакты  

* Поддержка осуществляется в рамках текущего функционала дополнения  
* При возникновении проблемы, создайте соотвествующую тему на [форуме поддержки](https://codeseller.ru/forum/product-15611/) товара  
* Если вам нужна доработка под ваши нужды - вы можете обратиться ко мне в <a href="https://codeseller.ru/author/otshelnik-fm/?tab=chat" target="_blank">ЛС</a> с техзаданием на платную доработку.  

Полный список моих работ опубликован на [моём сайте](https://otshelnik-fm.ru/all-my-addons-for-wp-recall/) и в каталоге магазина [CodeSeller.ru](https://codeseller.ru/author/otshelnik-fm/?tab=publics&subtab=type-products)  

------------------------------

## Author  

**Wladimir Druzhaev** (Otshelnik-Fm)  
